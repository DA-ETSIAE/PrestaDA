{% extends '__base.html' %}
{% load i18n %}

{% block title %}{% trans 'titles.index' %}{% endblock %}

{% block content %}
<div class="container is-fluid mt-5">

    <div id="message"></div>

    {% for notif in global_messages %}
        <article class="message is-{{ notif.color }}">
            {% if notif.title %}
                <div class="message-header">
                    <p><i class="iconoir-bell-notification"></i> {{ notif.title }}</p>
                </div>
            {% endif %}
            <div class="message-body">
                {{ notif.content }} {% if user.is_superuser %} <form hx-post="{% url 'delete_global_message' %}" > {% csrf_token %} <button name="id" value="{{ notif.id }}" class="button is-ghost">{% trans 'index.remove_message' %}</button> </form> {% endif %}
            </div>
        </article>
    {% endfor %}

    <div class="card mb-5">
        <div class="card-content">
            {% if message_count == 0 %}
                <p class="title is-3">
                    <i class="iconoir-double-check" style="color:#34b7f1"></i> {% trans 'index.no_unread' %}
                </p>
                {% trans 'index.no_unread_body' %}
            {% else %}
                <p class="title is-3">
                    <i class="iconoir-check"></i> {% trans 'index.your_feed' %}
                </p>
                <div class="messages-horizontal">
                    {% for m in user_messages %}
                        <div class="bubble-container" id="message-{{ m.id }}" >
                            <form hx-post="{% url 'read' m.id %}" hx-target="#message-{{ m.id }}" class="bubble-form" onsubmit="fadeOutBubble(event, 'message-{{ m.id }}')">
                                {% csrf_token %}
                                <button type="submit" class="bubble-button">
                                    <div class="bubble" {% if m.is_from_staff %} style="background-color: #7bd4ff" {% endif %}>
                                        <p>{{ m.content }}</p>
                                        <span class="timestamp">{{ m.date_created|date:"H:i - d/m/Y" }}</span>
                                    </div>
                                </button>
                            </form>
                        </div>
                    {% endfor %}

                </div>
            {% endif %}
        </div>
    </div>

    <div class="columns is-multiline">
        {% for p in user_petitions %}
            <div class="column is-full-mobile is-half-tablet is-one-quarter-desktop">
                <div class="card">
                    <header class="card-header">
                        <p class="card-header-title">
                            {{ p.type.name }}
                        </p>
                        <button class="card-header-icon" aria-label="toggle" onclick="toggleCard(this)">
                            <i class="iconoir-collapse"></i>
                        </button>
                    </header>
                    <div class="card-content">
                        {% if p.is_pending %}
                            <article class="message is-warning">
                                <div class="message-body">
                                    {% trans 'index.petition_pending' %}
                                </div>
                            </article>
                        {% else %}
                            <div class="content has-text-centered">
                                <p class="title is-5 mb-2">{{ p.item.code }}</p>
                                {% if p.item.notes %} <article class="message is-info"> <div class="message-body">  {{ p.item.notes }} </div> </article> {% endif %}
                                <p class="subtitle is-6">
                                    <span class="tag is-light is-medium">
                                        <i class="iconoir-calendar"></i> {{ p.until|date:"d/m/Y" }}
                                    </span>
                                </p>
                                <progress class="progress {{ p.color }}" max="100" value="{{ p.percent }}"></progress>
                            </div>
                        {% endif %}
                    </div>
                    <footer class="card-footer">
                        <a href="{% url 'petition' p.id %}" class="card-footer-item">{% trans 'index.petition_details' %}</a>
                        <a href="{% url 'print_petition' p.id %}" class="card-footer-item">{% trans 'index.petition_print_receipt' %}</a>
                    </footer>
                </div>
            </div>
        {% endfor %}
    </div>

</div>

{% endblock %}
